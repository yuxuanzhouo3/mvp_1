(()=>{var e={};e.id=6048,e.ids=[6048],e.modules={30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{"use strict";e.exports=require("buffer")},32081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},82361:e=>{"use strict";e.exports=require("events")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},41808:e=>{"use strict";e.exports=require("net")},85477:e=>{"use strict";e.exports=require("punycode")},12781:e=>{"use strict";e.exports=require("stream")},24404:e=>{"use strict";e.exports=require("tls")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},59796:e=>{"use strict";e.exports=require("zlib")},58359:()=>{},93739:()=>{},70113:(e,t,r)=>{"use strict";r.r(t),r.d(t,{headerHooks:()=>x,originalPathname:()=>v,patchFetch:()=>k,requestAsyncStorage:()=>y,routeModule:()=>f,serverHooks:()=>w,staticGenerationAsyncStorage:()=>q,staticGenerationBailout:()=>b});var s={};r.r(s),r.d(s,{POST:()=>_});var a=r(10884),i=r(16132),n=r(21040),o=r(95798),u=r(78888),p=r(16163);let c=new u.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"}),d=(0,p.eI)("https://bamratexknmqvdbalzen.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function _(e){let t;let r=await e.text(),s=e.headers.get("stripe-signature");try{t=c.webhooks.constructEvent(r,s,process.env.STRIPE_WEBHOOK_SECRET)}catch(e){return o.Z.json({error:"Webhook signature verification failed"},{status:400})}try{switch(t.type){case"payment_intent.succeeded":await m(t.data.object);break;case"payment_intent.payment_failed":await l(t.data.object);break;case"charge.refunded":await h(t.data.object)}return o.Z.json({received:!0})}catch(e){return o.Z.json({error:"Webhook handler failed"},{status:500})}}async function m(e){let{userId:t,creditsPurchased:r}=e.metadata;await d.from("transactions").update({status:"succeeded"}).eq("stripe_payment_intent_id",e.id),t&&r&&await d.from("profiles").update({credits:d.rpc("increment_credits",{user_id:t,credits_to_add:parseInt(r)})}).eq("id",t)}async function l(e){await d.from("transactions").update({status:"failed"}).eq("stripe_payment_intent_id",e.id)}async function h(e){let{data:t}=await d.from("transactions").select("user_id, credits_purchased").eq("stripe_payment_intent_id",e.payment_intent).single();t&&(await d.from("profiles").update({credits:d.rpc("decrement_credits",{user_id:t.user_id,credits_to_deduct:t.credits_purchased})}).eq("id",t.user_id),await d.from("transactions").update({status:"refunded"}).eq("stripe_payment_intent_id",e.payment_intent))}let f=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/payments/stripe/webhook/route",pathname:"/api/payments/stripe/webhook",filename:"route",bundlePath:"app/api/payments/stripe/webhook/route"},resolvedPagePath:"/Users/mac-guest1/Downloads/Git/mvp_projects/mvp_1/app/api/payments/stripe/webhook/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:y,staticGenerationAsyncStorage:q,serverHooks:w,headerHooks:x,staticGenerationBailout:b}=f,v="/api/payments/stripe/webhook/route";function k(){return(0,n.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:q})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[3271,1945,8107,8888],()=>r(70113));module.exports=s})();