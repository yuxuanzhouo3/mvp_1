(()=>{var e={};e.id=7996,e.ids=[7996,8181],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{"use strict";e.exports=require("buffer")},32081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},82361:e=>{"use strict";e.exports=require("events")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},41808:e=>{"use strict";e.exports=require("net")},85477:e=>{"use strict";e.exports=require("punycode")},12781:e=>{"use strict";e.exports=require("stream")},24404:e=>{"use strict";e.exports=require("tls")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},59796:e=>{"use strict";e.exports=require("zlib")},58359:()=>{},93739:()=>{},86036:(e,t,a)=>{"use strict";a.r(t),a.d(t,{headerHooks:()=>v,originalPathname:()=>E,patchFetch:()=>S,requestAsyncStorage:()=>h,routeModule:()=>w,serverHooks:()=>I,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>q});var r={};a.r(r),a.d(r,{POST:()=>l});var i=a(10884),s=a(16132),n=a(21040),o=a(95798),c=a(69978),d=a(78888),u=a(60943),p=a(92813);let m=new d.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"});async function l(e){try{let t=(0,c.e)(),{data:{user:a},error:r}=await t.auth.getUser();if(r||!a)return o.Z.json({error:"Unauthorized"},{status:401});let i=await e.json(),{packageId:s,paymentMethod:n,amount:d,credits:p}=i;if(!s||!n||!d||!p)return o.Z.json({error:"Missing required fields"},{status:400});if(!(0,u.ml)(d))return o.Z.json({error:"Invalid payment amount"},{status:400});if(!(0,u.cA)(p))return o.Z.json({error:"Invalid credit amount"},{status:400});let m=(0,u.Jh)(s);if(!m)return o.Z.json({error:"Invalid package ID"},{status:400});let l=await (0,u.Bi)(a.id,d,n,s,p);switch(n){case"stripe":return await y(l,d,p);case"usdt":return await _(l,d,a.id);case"alipay":return await f(l,d,a.id);default:return o.Z.json({error:"Unsupported payment method"},{status:400})}}catch(e){return o.Z.json({error:"Internal server error"},{status:500})}}async function y(e,t,a){try{let r=await m.checkout.sessions.create({payment_method_types:["card"],line_items:[{price_data:{currency:"cny",product_data:{name:`${a} Credits Package`,description:`Purchase ${a} credits for PersonaLink`},unit_amount:Math.round(100*t)},quantity:1}],mode:"payment",success_url:`${process.env.NEXT_PUBLIC_APP_URL}/payment/success?session_id={CHECKOUT_SESSION_ID}`,cancel_url:`${process.env.NEXT_PUBLIC_APP_URL}/payment/cancel`,metadata:{payment_id:e.id,user_id:e.user_id,credits:a.toString()}}),i=(0,c.e)();return await i.from("payments").update({stripe_payment_intent_id:r.id,metadata:{...e.metadata,stripe_session_id:r.id}}).eq("id",e.id),o.Z.json({checkoutUrl:r.url,sessionId:r.id})}catch(e){return o.Z.json({error:"Failed to create Stripe session"},{status:500})}}async function _(e,t,a){try{let r=await (0,p.eo)(e.id,t,a);return o.Z.json({paymentAddress:r.address,amount:r.amount,network:r.network,paymentId:r.paymentId,instructions:`Please send exactly ${t} USDT to the address above using ${r.network} network. Include the payment ID in the memo if possible.`})}catch(e){return o.Z.json({error:"Failed to create USDT payment"},{status:500})}}async function f(e,t,a){try{let r=await (0,p.VA)(e.id,t,a);return o.Z.json({qrCodeUrl:r.qrCode,amount:r.amount,account:r.account,paymentId:r.paymentId,instructions:`Please scan the QR code with Alipay to pay ${t} CNY. Make sure to include the payment ID in the note.`})}catch(e){return o.Z.json({error:"Failed to create Alipay payment"},{status:500})}}let w=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/payments/create-intent/route",pathname:"/api/payments/create-intent",filename:"route",bundlePath:"app/api/payments/create-intent/route"},resolvedPagePath:"/Users/mac-guest1/Downloads/Git/mvp_projects/mvp_1/app/api/payments/create-intent/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:g,serverHooks:I,headerHooks:v,staticGenerationBailout:q}=w,E="/api/payments/create-intent/route";function S(){return(0,n.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:g})}},92813:(e,t,a)=>{"use strict";a.d(t,{VA:()=>u,eo:()=>d,Ve:()=>m,iJ:()=>p});var r=a(69978);let i={usdtWallets:[{id:"trc20-main",address:"TQn9Y2khDD95J42FQtQTdwVVRKqyqjqjqj",network:"TRC20",label:"Main USDT Wallet (TRC20)",isActive:!0},{id:"erc20-main",address:"0x742d35Cc6634C0532925a3b8D4C9db96C4b4d8b8",network:"ERC20",label:"Main USDT Wallet (ERC20)",isActive:!0}],paymentReceivers:[{id:"alipay-main",type:"alipay",name:"支付宝收款",account:"your-alipay-account@example.com",isActive:!0},{id:"wechat-main",type:"wechat",name:"微信收款",account:"your-wechat-id",isActive:!0}],settings:{minAmount:1,maxAmount:1e4,paymentTimeout:30,autoRefundAfter:24,supportedCurrencies:["CNY","USD","EUR"],defaultCurrency:"CNY"},webhooks:{stripe:"https://your-domain.com/api/payments/webhook",alipay:"https://your-domain.com/api/payments/alipay-webhook"},apiKeys:{stripe:{publishableKey:process.env.STRIPE_PUBLISHABLE_KEY||"",secretKey:process.env.STRIPE_SECRET_KEY||"",webhookSecret:process.env.STRIPE_WEBHOOK_SECRET||""},alipay:{appId:process.env.ALIPAY_APP_ID||"",privateKey:process.env.ALIPAY_PRIVATE_KEY||"",publicKey:process.env.ALIPAY_PUBLIC_KEY||""}}},s=i.usdtWallets.filter(e=>e.isActive),n=i.paymentReceivers.filter(e=>e.isActive);async function o(){let e=s.filter(e=>e.isActive);return e.length>0?e[0]:null}async function c(e){let t=n.find(t=>t.type===e&&t.isActive);return t||null}async function d(e,t,a){let i=await o();if(!i)throw Error("No available USDT wallet");let s=(0,r.e)();return await s.from("payments").update({status:"pending",metadata:{usdt_address:i.address,usdt_network:i.network,usdt_amount:t,payment_id:e,user_id:a,created_at:new Date().toISOString()}}).eq("id",e),{address:i.address,amount:t,network:i.network,paymentId:e}}async function u(e,t,a){let i=await c("alipay");if(!i)throw Error("Alipay receiver not available");let s={amount:t,account:i.account,paymentId:e,timestamp:Date.now()},n=`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(JSON.stringify(s))}`,o=(0,r.e)();return await o.from("payments").update({status:"pending",metadata:{alipay_account:i.account,alipay_amount:t,alipay_qr_code:n,payment_id:e,user_id:a,created_at:new Date().toISOString()}}).eq("id",e),{qrCode:n,amount:t,account:i.account,paymentId:e}}async function p(e,t,a,i){try{let s=(0,r.e)(),{data:n,error:o}=await s.from("payments").select("*").eq("id",e).single();if(o||!n)return!1;let c=n.metadata?.usdt_amount,d=n.metadata?.usdt_address;if(a!==c||i.toLowerCase()!==d.toLowerCase())return!1;await s.from("payments").update({status:"completed",metadata:{...n.metadata,transaction_hash:t,verified_at:new Date().toISOString()}}).eq("id",e);let u=n.metadata?.credits||0;return u>0&&(await l(n.user_id,u),await y(n.user_id,"credit_purchase",u,`Purchased ${u} credits via USDT`,{payment_id:e,transaction_hash:t,payment_method:"usdt"})),!0}catch(e){return!1}}async function m(e,t,a){try{let i=(0,r.e)(),{data:s,error:n}=await i.from("payments").select("*").eq("id",e).single();if(n||!s)return!1;let o=s.metadata?.alipay_amount;if(a!==o)return!1;await i.from("payments").update({status:"completed",metadata:{...s.metadata,alipay_transaction_id:t,verified_at:new Date().toISOString()}}).eq("id",e);let c=s.metadata?.credits||0;return c>0&&(await l(s.user_id,c),await y(s.user_id,"credit_purchase",c,`Purchased ${c} credits via Alipay`,{payment_id:e,alipay_transaction_id:t,payment_method:"alipay"})),!0}catch(e){return!1}}async function l(e,t){let a=(0,r.e)(),{data:i,error:s}=await a.from("profiles").select("credits").eq("id",e).single();if(s)throw Error(`Failed to fetch user profile: ${s.message}`);let n=i?.credits||0,{error:o}=await a.from("profiles").update({credits:n+t,updated_at:new Date().toISOString()}).eq("id",e);if(o)throw Error(`Failed to add credits to user: ${o.message}`)}async function y(e,t,a,i,s){let n=(0,r.e)(),{error:o}=await n.from("transactions").insert({user_id:e,type:t,amount:a,currency:"CNY",description:i,status:"completed",metadata:s});if(o)throw Error(`Failed to create transaction record: ${o.message}`)}},60943:(e,t,a)=>{"use strict";a.d(t,{Bi:()=>s,Jh:()=>m,LB:()=>d,bH:()=>l,cA:()=>p,ml:()=>u});var r=a(69978);new(a(78888)).Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"});let i=[{id:"starter",name:"入门包",credits:50,price:9.99,features:["50 积分","基础匹配","标准客服"]},{id:"popular",name:"热门包",credits:150,price:24.99,originalPrice:29.99,popular:!0,features:["150 积分","优先匹配","优先客服","高级筛选"]},{id:"premium",name:"高级包",credits:300,price:44.99,originalPrice:59.99,bestValue:!0,features:["300 积分","超级匹配","专属客服","无限筛选","数据分析"]},{id:"ultimate",name:"终极包",credits:500,price:69.99,originalPrice:99.99,features:["500 积分","VIP 匹配","24/7 客服","所有功能","专属活动"]}];async function s(e,t,a,i,s){let n=(0,r.e)(),{data:o,error:c}=await n.from("payments").insert({user_id:e,amount:t,currency:"CNY",payment_method:a,status:"pending",description:`Purchase ${s} credits - ${i} package`,metadata:{packageId:i,credits:s,paymentMethod:a}}).select().single();if(c)throw Error(`Failed to create payment record: ${c.message}`);return o}async function n(e,t,a){let i=(0,r.e)(),s={status:t,updated_at:new Date().toISOString()};a&&(s.metadata=a);let{error:n}=await i.from("payments").update(s).eq("id",e);if(n)throw Error(`Failed to update payment status: ${n.message}`)}async function o(e,t){let a=(0,r.e)(),{data:i,error:s}=await a.from("profiles").select("credits").eq("id",e).single();if(s)throw Error(`Failed to fetch user profile: ${s.message}`);let n=i?.credits||0,{error:o}=await a.from("profiles").update({credits:n+t,updated_at:new Date().toISOString()}).eq("id",e);if(o)throw Error(`Failed to add credits to user: ${o.message}`)}async function c(e,t,a,i,s){let n=(0,r.e)(),{error:o}=await n.from("transactions").insert({user_id:e,type:t,amount:a,currency:"CNY",description:i,status:"completed",metadata:s});if(o)throw Error(`Failed to create transaction record: ${o.message}`)}async function d(e,t=10,a=0,i){let s=(0,r.e)(),n=s.from("payments").select("*").eq("user_id",e).order("created_at",{ascending:!1}).range(a,a+t-1);i&&(n=n.eq("status",i));let{data:o,error:c}=await n;if(c)throw Error(`Failed to get payment history: ${c.message}`);return o||[]}function u(e){return e>0&&e<=1e4}function p(e){return e>0&&e<=1e4}function m(e){return i.find(t=>t.id===e)}async function l(e){let t=(0,r.e)();switch(e.type){case"checkout.session.completed":let a=e.data.object;await y(a,t);break;case"payment_intent.succeeded":let i=e.data.object;await _(i,t);break;case"payment_intent.payment_failed":let s=e.data.object;await f(s,t)}}async function y(e,t){let a=e.metadata?.payment_id,r=e.metadata?.user_id,i=parseInt(e.metadata?.credits||"0");if(!a||!r||!i)throw Error("Missing metadata in checkout session");await n(a,"completed",{stripe_session_id:e.id,stripe_charge_id:e.payment_intent}),await o(r,i),await c(r,"credit_purchase",i,`Purchased ${i} credits via Stripe`,{payment_id:a,stripe_session_id:e.id,payment_method:"stripe"})}async function _(e,t){let{data:a}=await t.from("payments").select("*").eq("stripe_payment_intent_id",e.id).single();a&&"completed"!==a.status&&await n(a.id,"completed",{stripe_charge_id:e.latest_charge})}async function f(e,t){let{data:a}=await t.from("payments").select("*").eq("stripe_payment_intent_id",e.id).single();a&&await n(a.id,"failed")}process.env.STRIPE_SECRET_KEY},69978:(e,t,a)=>{"use strict";a.d(t,{e:()=>s});var r=a(74280),i=a(24596);let s=()=>{let e=(0,i.cookies)();return(0,r.createServerClient)("https://bamratexknmqvdbalzen.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhbXJhdGV4a25tcXZkYmFsemVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MTM4NzEsImV4cCI6MjA2ODA4OTg3MX0.yYa98ioJLLouUgHWITGb7U_VjNCTUuM-5NcraM7f3zA",{cookies:{get:t=>e.get(t)?.value,set(t,a,r){e.set({name:t,value:a,...r})},remove(t,a){e.set({name:t,value:"",...a})}}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[3271,8107,6163,782,8888],()=>a(86036));module.exports=r})();