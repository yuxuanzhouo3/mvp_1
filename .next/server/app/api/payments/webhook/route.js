(()=>{var e={};e.id=1004,e.ids=[1004,8181],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{"use strict";e.exports=require("buffer")},32081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},82361:e=>{"use strict";e.exports=require("events")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},41808:e=>{"use strict";e.exports=require("net")},85477:e=>{"use strict";e.exports=require("punycode")},12781:e=>{"use strict";e.exports=require("stream")},24404:e=>{"use strict";e.exports=require("tls")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},59796:e=>{"use strict";e.exports=require("zlib")},58359:()=>{},93739:()=>{},55119:(e,t,r)=>{"use strict";r.r(t),r.d(t,{headerHooks:()=>_,originalPathname:()=>x,patchFetch:()=>q,requestAsyncStorage:()=>y,routeModule:()=>h,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>w});var s={};r.r(s),r.d(s,{POST:()=>m});var a=r(10884),i=r(16132),n=r(21040),o=r(95798),c=r(69978),u=r(78888),p=r(60943);let d=new u.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"}),l=process.env.STRIPE_WEBHOOK_SECRET;async function m(e){try{let t;let r=await e.text(),s=e.headers.get("stripe-signature");if(!s)return o.Z.json({error:"Missing stripe signature"},{status:400});try{t=d.webhooks.constructEvent(r,s,l)}catch(e){return o.Z.json({error:"Invalid signature"},{status:400})}return(0,c.e)(),await (0,p.bH)(t),o.Z.json({received:!0})}catch(e){return o.Z.json({error:"Webhook handler failed"},{status:500})}}let h=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/payments/webhook/route",pathname:"/api/payments/webhook",filename:"route",bundlePath:"app/api/payments/webhook/route"},resolvedPagePath:"/Users/mac-guest1/Downloads/Git/mvp_projects/mvp_1/app/api/payments/webhook/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:y,staticGenerationAsyncStorage:f,serverHooks:g,headerHooks:_,staticGenerationBailout:w}=h,x="/api/payments/webhook/route";function q(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},60943:(e,t,r)=>{"use strict";r.d(t,{Bi:()=>i,Jh:()=>l,LB:()=>u,bH:()=>m,cA:()=>d,ml:()=>p});var s=r(69978);new(r(78888)).Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"});let a=[{id:"starter",name:"入门包",credits:50,price:9.99,features:["50 积分","基础匹配","标准客服"]},{id:"popular",name:"热门包",credits:150,price:24.99,originalPrice:29.99,popular:!0,features:["150 积分","优先匹配","优先客服","高级筛选"]},{id:"premium",name:"高级包",credits:300,price:44.99,originalPrice:59.99,bestValue:!0,features:["300 积分","超级匹配","专属客服","无限筛选","数据分析"]},{id:"ultimate",name:"终极包",credits:500,price:69.99,originalPrice:99.99,features:["500 积分","VIP 匹配","24/7 客服","所有功能","专属活动"]}];async function i(e,t,r,a,i){let n=(0,s.e)(),{data:o,error:c}=await n.from("payments").insert({user_id:e,amount:t,currency:"CNY",payment_method:r,status:"pending",description:`Purchase ${i} credits - ${a} package`,metadata:{packageId:a,credits:i,paymentMethod:r}}).select().single();if(c)throw Error(`Failed to create payment record: ${c.message}`);return o}async function n(e,t,r){let a=(0,s.e)(),i={status:t,updated_at:new Date().toISOString()};r&&(i.metadata=r);let{error:n}=await a.from("payments").update(i).eq("id",e);if(n)throw Error(`Failed to update payment status: ${n.message}`)}async function o(e,t){let r=(0,s.e)(),{data:a,error:i}=await r.from("profiles").select("credits").eq("id",e).single();if(i)throw Error(`Failed to fetch user profile: ${i.message}`);let n=a?.credits||0,{error:o}=await r.from("profiles").update({credits:n+t,updated_at:new Date().toISOString()}).eq("id",e);if(o)throw Error(`Failed to add credits to user: ${o.message}`)}async function c(e,t,r,a,i){let n=(0,s.e)(),{error:o}=await n.from("transactions").insert({user_id:e,type:t,amount:r,currency:"CNY",description:a,status:"completed",metadata:i});if(o)throw Error(`Failed to create transaction record: ${o.message}`)}async function u(e,t=10,r=0,a){let i=(0,s.e)(),n=i.from("payments").select("*").eq("user_id",e).order("created_at",{ascending:!1}).range(r,r+t-1);a&&(n=n.eq("status",a));let{data:o,error:c}=await n;if(c)throw Error(`Failed to get payment history: ${c.message}`);return o||[]}function p(e){return e>0&&e<=1e4}function d(e){return e>0&&e<=1e4}function l(e){return a.find(t=>t.id===e)}async function m(e){let t=(0,s.e)();switch(e.type){case"checkout.session.completed":let r=e.data.object;await h(r,t);break;case"payment_intent.succeeded":let a=e.data.object;await y(a,t);break;case"payment_intent.payment_failed":let i=e.data.object;await f(i,t)}}async function h(e,t){let r=e.metadata?.payment_id,s=e.metadata?.user_id,a=parseInt(e.metadata?.credits||"0");if(!r||!s||!a)throw Error("Missing metadata in checkout session");await n(r,"completed",{stripe_session_id:e.id,stripe_charge_id:e.payment_intent}),await o(s,a),await c(s,"credit_purchase",a,`Purchased ${a} credits via Stripe`,{payment_id:r,stripe_session_id:e.id,payment_method:"stripe"})}async function y(e,t){let{data:r}=await t.from("payments").select("*").eq("stripe_payment_intent_id",e.id).single();r&&"completed"!==r.status&&await n(r.id,"completed",{stripe_charge_id:e.latest_charge})}async function f(e,t){let{data:r}=await t.from("payments").select("*").eq("stripe_payment_intent_id",e.id).single();r&&await n(r.id,"failed")}process.env.STRIPE_SECRET_KEY},69978:(e,t,r)=>{"use strict";r.d(t,{e:()=>i});var s=r(74280),a=r(24596);let i=()=>{let e=(0,a.cookies)();return(0,s.createServerClient)("https://bamratexknmqvdbalzen.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhbXJhdGV4a25tcXZkYmFsemVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MTM4NzEsImV4cCI6MjA2ODA4OTg3MX0.yYa98ioJLLouUgHWITGb7U_VjNCTUuM-5NcraM7f3zA",{cookies:{get:t=>e.get(t)?.value,set(t,r,s){e.set({name:t,value:r,...s})},remove(t,r){e.set({name:t,value:"",...r})}}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[3271,8107,6163,782,8888],()=>r(55119));module.exports=s})();