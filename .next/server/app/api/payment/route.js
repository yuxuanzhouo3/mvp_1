"use strict";(()=>{var e={};e.id=8077,e.ids=[8077],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},7026:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>h,originalPathname:()=>f,patchFetch:()=>q,requestAsyncStorage:()=>y,routeModule:()=>l,serverHooks:()=>g,staticGenerationAsyncStorage:()=>_,staticGenerationBailout:()=>x});var a={};r.r(a),r.d(a,{POST:()=>c,PUT:()=>m});var s=r(10884),n=r(16132),i=r(21040),o=r(95798),u=r(78888),p=r(20116);let d=new u.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"});async function c(e){try{let{userId:t,amount:r,currency:a,paymentMethod:s,credits:n}=await e.json();if(!t||!r||!n)return o.Z.json({error:{message:"Missing required fields"}},{status:400});let i=await d.paymentIntents.create({amount:Math.round(100*r),currency:a||"usd",payment_method_types:"alipay"===s?["alipay"]:["card"],metadata:{userId:t,credits:n.toString(),paymentMethod:s},automatic_payment_methods:{enabled:!0}}),u=p.db.getInstance(),c=await p.db.executeWithRetry(async()=>{let{error:e}=await u.from("transactions").insert({user_id:t,amount:r,currency:a||"usd",payment_method:s,status:"pending",stripe_payment_intent_id:i.id,credits_purchased:n,created_at:new Date().toISOString()});return{error:e}},"payment transaction save"),{error:m}=c;return o.Z.json({clientSecret:i.client_secret,paymentIntentId:i.id,amount:i.amount,currency:i.currency})}catch(e){return o.Z.json({error:{message:e.message||"Payment processing failed"}},{status:500})}}async function m(e){try{let{paymentIntentId:t,status:r}=await e.json();if(!t||!r)return o.Z.json({error:{message:"Missing payment intent ID or status"}},{status:400});let a=p.db.getInstance(),{error:s}=await a.from("transactions").update({status:r,updated_at:new Date().toISOString()}).eq("stripe_payment_intent_id",t);if(s)return o.Z.json({error:{message:"Failed to update transaction"}},{status:500});if("succeeded"===r){let{data:e}=await a.from("transactions").select("user_id, credits_purchased").eq("stripe_payment_intent_id",t).single();if(e){let{error:t}=await a.from("profiles").update({credits:a.rpc("increment_credits",{user_id:e.user_id,amount:e.credits_purchased})}).eq("id",e.user_id)}}return o.Z.json({success:!0})}catch(e){return o.Z.json({error:{message:e.message||"Failed to update payment"}},{status:500})}}p.db.getInitializationStatus||(0,p.x)();let l=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/payment/route",pathname:"/api/payment",filename:"route",bundlePath:"app/api/payment/route"},resolvedPagePath:"/Users/mac-guest1/Downloads/Git/mvp_projects/mvp_1/app/api/payment/route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:_,serverHooks:g,headerHooks:h,staticGenerationBailout:x}=l,f="/api/payment/route";function q(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:_})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[3271,1945,8107,8888,3665],()=>r(7026));module.exports=a})();