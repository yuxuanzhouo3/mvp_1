(()=>{var e={};e.id=6807,e.ids=[6807,8181],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{"use strict";e.exports=require("buffer")},32081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},82361:e=>{"use strict";e.exports=require("events")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},41808:e=>{"use strict";e.exports=require("net")},85477:e=>{"use strict";e.exports=require("punycode")},12781:e=>{"use strict";e.exports=require("stream")},24404:e=>{"use strict";e.exports=require("tls")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},59796:e=>{"use strict";e.exports=require("zlib")},58359:()=>{},93739:()=>{},80502:(e,t,r)=>{"use strict";r.r(t),r.d(t,{headerHooks:()=>g,originalPathname:()=>h,patchFetch:()=>_,requestAsyncStorage:()=>l,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>y});var a={};r.r(a),r.d(a,{GET:()=>d});var s=r(10884),i=r(16132),n=r(21040),o=r(95798),c=r(69978),u=r(60943);async function d(e){try{let t=(0,c.e)(),{data:{user:r},error:a}=await t.auth.getUser();if(a||!r)return o.Z.json({error:"Unauthorized"},{status:401});let{searchParams:s}=new URL(e.url),i=parseInt(s.get("limit")||"10"),n=parseInt(s.get("offset")||"0"),{data:d,error:p}=await t.from("profiles").select("credits").eq("id",r.id).single(),l=await (0,u.LB)(r.id,i,n),{data:m,error:f}=await t.from("transactions").select("*").eq("user_id",r.id).order("created_at",{ascending:!1}).range(n,n+i-1);return o.Z.json({balance:d?.credits||0,records:l.map(e=>({id:e.id,type:"payment",amount:e.amount,currency:e.currency,status:e.status,paymentMethod:e.payment_method,description:e.description,createdAt:e.created_at,metadata:e.metadata})),transactions:m||[],pagination:{limit:i,offset:n,hasMore:l.length===i}})}catch(e){return o.Z.json({error:"Internal server error"},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/user/billing/route",pathname:"/api/user/billing",filename:"route",bundlePath:"app/api/user/billing/route"},resolvedPagePath:"/Users/mac-guest1/Downloads/Git/mvp_projects/mvp_1/app/api/user/billing/route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:l,staticGenerationAsyncStorage:m,serverHooks:f,headerHooks:g,staticGenerationBailout:y}=p,h="/api/user/billing/route";function _(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}},60943:(e,t,r)=>{"use strict";r.d(t,{Bi:()=>i,Jh:()=>l,LB:()=>u,bH:()=>m,cA:()=>p,ml:()=>d});var a=r(69978);new(r(78888)).Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"});let s=[{id:"starter",name:"入门包",credits:50,price:9.99,features:["50 积分","基础匹配","标准客服"]},{id:"popular",name:"热门包",credits:150,price:24.99,originalPrice:29.99,popular:!0,features:["150 积分","优先匹配","优先客服","高级筛选"]},{id:"premium",name:"高级包",credits:300,price:44.99,originalPrice:59.99,bestValue:!0,features:["300 积分","超级匹配","专属客服","无限筛选","数据分析"]},{id:"ultimate",name:"终极包",credits:500,price:69.99,originalPrice:99.99,features:["500 积分","VIP 匹配","24/7 客服","所有功能","专属活动"]}];async function i(e,t,r,s,i){let n=(0,a.e)(),{data:o,error:c}=await n.from("payments").insert({user_id:e,amount:t,currency:"CNY",payment_method:r,status:"pending",description:`Purchase ${i} credits - ${s} package`,metadata:{packageId:s,credits:i,paymentMethod:r}}).select().single();if(c)throw Error(`Failed to create payment record: ${c.message}`);return o}async function n(e,t,r){let s=(0,a.e)(),i={status:t,updated_at:new Date().toISOString()};r&&(i.metadata=r);let{error:n}=await s.from("payments").update(i).eq("id",e);if(n)throw Error(`Failed to update payment status: ${n.message}`)}async function o(e,t){let r=(0,a.e)(),{data:s,error:i}=await r.from("profiles").select("credits").eq("id",e).single();if(i)throw Error(`Failed to fetch user profile: ${i.message}`);let n=s?.credits||0,{error:o}=await r.from("profiles").update({credits:n+t,updated_at:new Date().toISOString()}).eq("id",e);if(o)throw Error(`Failed to add credits to user: ${o.message}`)}async function c(e,t,r,s,i){let n=(0,a.e)(),{error:o}=await n.from("transactions").insert({user_id:e,type:t,amount:r,currency:"CNY",description:s,status:"completed",metadata:i});if(o)throw Error(`Failed to create transaction record: ${o.message}`)}async function u(e,t=10,r=0,s){let i=(0,a.e)(),n=i.from("payments").select("*").eq("user_id",e).order("created_at",{ascending:!1}).range(r,r+t-1);s&&(n=n.eq("status",s));let{data:o,error:c}=await n;if(c)throw Error(`Failed to get payment history: ${c.message}`);return o||[]}function d(e){return e>0&&e<=1e4}function p(e){return e>0&&e<=1e4}function l(e){return s.find(t=>t.id===e)}async function m(e){let t=(0,a.e)();switch(e.type){case"checkout.session.completed":let r=e.data.object;await f(r,t);break;case"payment_intent.succeeded":let s=e.data.object;await g(s,t);break;case"payment_intent.payment_failed":let i=e.data.object;await y(i,t)}}async function f(e,t){let r=e.metadata?.payment_id,a=e.metadata?.user_id,s=parseInt(e.metadata?.credits||"0");if(!r||!a||!s)throw Error("Missing metadata in checkout session");await n(r,"completed",{stripe_session_id:e.id,stripe_charge_id:e.payment_intent}),await o(a,s),await c(a,"credit_purchase",s,`Purchased ${s} credits via Stripe`,{payment_id:r,stripe_session_id:e.id,payment_method:"stripe"})}async function g(e,t){let{data:r}=await t.from("payments").select("*").eq("stripe_payment_intent_id",e.id).single();r&&"completed"!==r.status&&await n(r.id,"completed",{stripe_charge_id:e.latest_charge})}async function y(e,t){let{data:r}=await t.from("payments").select("*").eq("stripe_payment_intent_id",e.id).single();r&&await n(r.id,"failed")}process.env.STRIPE_SECRET_KEY},69978:(e,t,r)=>{"use strict";r.d(t,{e:()=>i});var a=r(74280),s=r(24596);let i=()=>{let e=(0,s.cookies)();return(0,a.createServerClient)("https://bamratexknmqvdbalzen.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhbXJhdGV4a25tcXZkYmFsemVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MTM4NzEsImV4cCI6MjA2ODA4OTg3MX0.yYa98ioJLLouUgHWITGb7U_VjNCTUuM-5NcraM7f3zA",{cookies:{get:t=>e.get(t)?.value,set(t,r,a){e.set({name:t,value:r,...a})},remove(t,r){e.set({name:t,value:"",...r})}}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[3271,8107,6163,782,8888],()=>r(80502));module.exports=a})();