(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[702],{261:function(e,t,s){Promise.resolve().then(s.bind(s,227))},227:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return j}});var a=s(7437),l=s(2265),r=s(4033),i=s(4620),n=s(446),c=s(1492),d=s(8004),o=s(9409),x=s(3067),m=s(7480),u=s(2882),h=s(7810),b=s(1738),g=s(7972),f=s(6142),p=s(9883);function j(){var e,t;let{user:s,signOut:j,loading:y}=(0,i.a)(),N=(0,r.useRouter)(),v=(0,r.usePathname)(),{toast:w}=(0,n.p)(),I=(0,c.eI)("https://bamratexknmqvdbalzen.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhbXJhdGV4a25tcXZkYmFsemVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MTM4NzEsImV4cCI6MjA2ODA4OTg3MX0.yYa98ioJLLouUgHWITGb7U_VjNCTUuM-5NcraM7f3zA"),[k,S]=(0,l.useState)(null),[C,T]=(0,l.useState)([]),[_,O]=(0,l.useState)(null),[A,E]=(0,l.useState)(!0),[M,Z]=(0,l.useState)(!1),[J,z]=(0,l.useState)(!1),U=async()=>{if(null==s?void 0:s.id)try{E(!0);let{data:{session:t}}=await I.auth.getSession(),s=null==t?void 0:t.access_token;if(!s)return;let a={Authorization:"Bearer ".concat(s),"Content-Type":"application/json"},l=await fetch("/api/user/profile",{headers:a});if(l.ok){let e=await l.json();S(e.profile)}let r=await fetch("/api/user/matches",{headers:a});if(r.ok){var e;let t=await r.json();T((null===(e=t.matches)||void 0===e?void 0:e.slice(0,5))||[])}let i=await fetch("/api/user/stats",{headers:a});if(i.ok){let e=await i.json();O(e.stats)}}catch(e){}finally{E(!1)}};if((0,l.useEffect)(()=>{if(!y){if(Z(!0),s&&s.id)U();else{S(null),T([]),O(null),E(!1),N.push("/auth/login");return}}},[s,y,M]),A||y)return(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),(0,a.jsx)("p",{className:"mt-4 text-gray-600",children:"加载中..."})]})});if(!k)return(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,a.jsxs)("div",{className:"bg-white p-8 rounded-lg shadow-md text-center max-w-md",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"无法加载用户资料"}),(0,a.jsx)("p",{className:"text-gray-600 mb-4",children:"请稍后重试或联系客服。"}),(0,a.jsx)("button",{onClick:()=>window.location.reload(),className:"bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md transition-colors",children:"刷新页面"})]})});let D=async()=>{try{await j(),window.location.href="/auth/login",w({title:"已退出登录",description:"期待您的再次光临！"})}catch(e){w({title:"退出失败",description:"请稍后重试",variant:"destructive"})}},X="/dashboard/settings"===v;return(0,a.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[!X&&(0,a.jsx)("header",{className:"bg-white shadow-sm border-b",children:(0,a.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,a.jsxs)("div",{className:"flex justify-between items-center h-16",children:[(0,a.jsx)("button",{onClick:()=>z(!J),className:"absolute left-2 top-1/2 transform -translate-y-1/2 z-50 p-2 rounded-md text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition-colors",style:{left:"1%"},children:(0,a.jsx)(d.Z,{className:"h-5 w-5"})}),(0,a.jsx)("div",{className:"flex-1 flex justify-center",children:(0,a.jsx)("h1",{className:"text-xl font-bold text-blue-600",children:"PersonaLink"})}),(0,a.jsx)("div",{className:"relative",children:(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("div",{className:"w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-medium",children:null===(e=k.full_name)||void 0===e?void 0:e.charAt(0).toUpperCase()}),(0,a.jsx)("span",{className:"text-sm font-medium text-gray-700 hidden sm:block",children:k.full_name})]}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("button",{className:"flex items-center space-x-1 text-gray-600 hover:text-gray-900 transition-colors",children:(0,a.jsx)(o.Z,{className:"h-4 w-4"})}),(0,a.jsxs)("div",{className:"absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10 hidden group-hover:block",children:[(0,a.jsx)("button",{onClick:()=>N.push("/dashboard/settings"),className:"block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100",children:"设置"}),(0,a.jsx)("button",{onClick:()=>N.push("/dashboard/notifications"),className:"block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100",children:"通知"}),(0,a.jsx)("hr",{className:"my-1"}),(0,a.jsx)("button",{onClick:D,className:"block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100",children:"退出登录"})]})]})]})})]})})}),(0,a.jsxs)("div",{className:"fixed inset-y-0 left-0 z-40 w-64 bg-white shadow-lg transform transition-transform duration-300 ease-in-out ".concat(J?"translate-x-0":"-translate-x-full"),children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-4 border-b",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:"PersonaLink"}),(0,a.jsx)("button",{onClick:()=>z(!1),className:"text-gray-500 hover:text-gray-700",children:(0,a.jsx)(x.Z,{className:"h-5 w-5"})})]}),(0,a.jsx)("nav",{className:"mt-4",children:(0,a.jsxs)("div",{className:"px-4 space-y-2",children:[(0,a.jsxs)("button",{onClick:()=>{N.push("/dashboard"),z(!1)},className:"w-full flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 hover:text-gray-900",children:[(0,a.jsx)(m.Z,{className:"mr-3 h-5 w-5"}),"首页"]}),(0,a.jsxs)("button",{onClick:()=>{N.push("/chat"),z(!1)},className:"w-full flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 hover:text-gray-900",children:[(0,a.jsx)(u.Z,{className:"mr-3 h-5 w-5"}),"聊天"]}),(0,a.jsxs)("button",{onClick:()=>{N.push("/matching"),z(!1)},className:"w-full flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 hover:text-gray-900",children:[(0,a.jsx)(h.Z,{className:"mr-3 h-5 w-5"}),"匹配"]}),(0,a.jsxs)("button",{onClick:()=>{N.push("/payment/recharge"),z(!1)},className:"w-full flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 hover:text-gray-900",children:[(0,a.jsx)(b.Z,{className:"mr-3 h-5 w-5"}),"充值"]}),(0,a.jsxs)("button",{onClick:()=>{N.push("/dashboard/settings"),z(!1)},className:"w-full flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 hover:text-gray-900",children:[(0,a.jsx)(o.Z,{className:"mr-3 h-5 w-5"}),"设置"]})]})})]}),J&&(0,a.jsx)("div",{className:"fixed inset-0 z-30 bg-black bg-opacity-50",onClick:()=>z(!1)}),(0,a.jsx)("div",{className:"".concat(X?"":"pt-16"," transition-all duration-300"),children:(0,a.jsxs)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6",children:[(0,a.jsx)("div",{className:"mb-6",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-sm p-6 text-center",children:[(0,a.jsxs)("h2",{className:"text-2xl font-bold text-blue-600 mb-2",children:["欢迎回来，",k.full_name,"！"]}),(0,a.jsx)("p",{className:"text-gray-600",children:"发现新的朋友，开始有趣的对话"})]})}),(0,a.jsx)("div",{className:"mb-6",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-sm",children:[(0,a.jsx)("div",{className:"px-6 py-4 border-b border-gray-200",children:(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:"快速操作"})}),(0,a.jsx)("div",{className:"p-6",children:(0,a.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,a.jsxs)("button",{onClick:()=>{N.push("/matching")},className:"flex items-center justify-center px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[(0,a.jsx)(h.Z,{className:"mr-2 h-5 w-5"}),"开始匹配"]}),(0,a.jsxs)("button",{onClick:()=>{N.push("/chat")},className:"flex items-center justify-center px-4 py-3 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 transition-colors",children:[(0,a.jsx)(u.Z,{className:"mr-2 h-5 w-5"}),"查看聊天"]})]})})]})}),_&&(0,a.jsx)("div",{className:"mb-6",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-sm",children:[(0,a.jsx)("div",{className:"px-6 py-4 border-b border-gray-200",children:(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:"数据统计"})}),(0,a.jsxs)("div",{className:"p-6",children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4",children:[(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-blue-600",children:_.totalMatches}),(0,a.jsx)("div",{className:"text-sm text-gray-600",children:"总匹配数"})]}),(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-green-600",children:_.totalMessages}),(0,a.jsx)("div",{className:"text-sm text-gray-600",children:"消息数量"})]}),(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-indigo-600",children:_.activeChats}),(0,a.jsx)("div",{className:"text-sm text-gray-600",children:"活跃聊天"})]}),(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsxs)("div",{className:"text-2xl font-bold text-yellow-600",children:[_.profileCompletion,"%"]}),(0,a.jsx)("div",{className:"text-sm text-gray-600",children:"资料完整度"})]})]}),(0,a.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2",children:(0,a.jsx)("div",{className:"bg-yellow-500 h-2 rounded-full transition-all duration-300",style:{width:"".concat(_.profileCompletion,"%")}})})]})]})}),(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6",children:[(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-sm",children:[(0,a.jsx)("div",{className:"px-6 py-4 border-b border-gray-200",children:(0,a.jsxs)("h3",{className:"text-lg font-semibold text-gray-900 flex items-center",children:[(0,a.jsx)(g.Z,{className:"mr-2 h-5 w-5"}),"个人资料"]})}),(0,a.jsxs)("div",{className:"p-6",children:[(0,a.jsxs)("div",{className:"flex items-center mb-4",children:[(0,a.jsx)("div",{className:"w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white text-lg font-semibold mr-4",children:null===(t=k.full_name)||void 0===t?void 0:t.charAt(0).toUpperCase()}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h4",{className:"font-semibold text-gray-900",children:k.full_name}),(0,a.jsx)("p",{className:"text-sm text-gray-600",children:k.email})]})]}),k.location&&(0,a.jsxs)("p",{className:"text-sm text-gray-600 mb-3 flex items-center",children:[(0,a.jsx)(f.Z,{className:"mr-1 h-4 w-4"}),k.location]}),k.interests&&k.interests.length>0&&(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)("p",{className:"text-sm text-gray-600 mb-2",children:"兴趣爱好"}),(0,a.jsxs)("div",{className:"flex flex-wrap gap-2",children:[k.interests.slice(0,3).map((e,t)=>(0,a.jsx)("span",{className:"px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full",children:e},t)),k.interests.length>3&&(0,a.jsxs)("span",{className:"px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full",children:["+",k.interests.length-3]})]})]}),(0,a.jsx)("button",{onClick:()=>N.push("/profile/edit"),className:"w-full px-4 py-2 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 transition-colors",children:"编辑资料"})]})]}),(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-sm",children:[(0,a.jsx)("div",{className:"px-6 py-4 border-b border-gray-200",children:(0,a.jsxs)("h3",{className:"text-lg font-semibold text-gray-900 flex items-center",children:[(0,a.jsx)(b.Z,{className:"mr-2 h-5 w-5"}),"积分余额"]})}),(0,a.jsxs)("div",{className:"p-6 text-center",children:[(0,a.jsx)("div",{className:"text-4xl font-bold text-blue-600 mb-2",children:k.credits}),(0,a.jsx)("p",{className:"text-sm text-gray-600 mb-4",children:"可用积分"}),(0,a.jsxs)("button",{onClick:()=>{N.push("/payment/recharge")},className:"w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center",children:[(0,a.jsx)(p.Z,{className:"mr-2 h-5 w-5"}),"充值积分"]})]})]})]}),C.length>0&&(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-sm",children:[(0,a.jsxs)("div",{className:"px-6 py-4 border-b border-gray-200 flex justify-between items-center",children:[(0,a.jsxs)("h3",{className:"text-lg font-semibold text-gray-900 flex items-center",children:[(0,a.jsx)(h.Z,{className:"mr-2 h-5 w-5"}),"最近匹配"]}),(0,a.jsx)("button",{onClick:()=>N.push("/matching/history"),className:"text-sm text-blue-600 hover:text-blue-700",children:"查看全部"})]}),(0,a.jsx)("div",{className:"divide-y divide-gray-200",children:C.map(e=>{var t;return(0,a.jsx)("div",{className:"px-6 py-4",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("div",{className:"w-10 h-10 bg-gray-600 rounded-full flex items-center justify-center text-white text-sm font-semibold mr-3",children:null===(t=e.matched_user.full_name)||void 0===t?void 0:t.charAt(0).toUpperCase()}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h4",{className:"font-semibold text-gray-900",children:e.matched_user.full_name}),(0,a.jsxs)("p",{className:"text-sm text-gray-600",children:["匹配度: ",e.compatibility_score,"%"]})]})]}),(0,a.jsx)("button",{onClick:()=>N.push("/chat/".concat(e.id)),className:"px-4 py-2 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 transition-colors",children:"聊天"})]})},e.id)})})]})]})})]})}},4620:function(e,t,s){"use strict";s.d(t,{H:function(){return c},a:function(){return d}});var a=s(7437),l=s(2265),r=s(1492);let i=null,n=(0,l.createContext)(void 0);function c(e){let{children:t}=e,[s,c]=(0,l.useState)(null),[d,o]=(0,l.useState)(null),[x,m]=(0,l.useState)(!0),u=(0,l.useRef)(!1),h=(0,l.useRef)(null),b=function(){if(!i){let e="https://bamratexknmqvdbalzen.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhbXJhdGV4a25tcXZkYmFsemVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MTM4NzEsImV4cCI6MjA2ODA4OTg3MX0.yYa98ioJLLouUgHWITGb7U_VjNCTUuM-5NcraM7f3zA";if(!e||!t)throw Error("Missing Supabase environment variables");i=(0,r.eI)(e,t,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0,storage:window.localStorage}})}return i}();(0,l.useEffect)(()=>{if(u.current)return;u.current=!0;let e=async()=>{try{let{data:{session:e},error:t}=await b.auth.getSession();t||e&&(o(e),c(e.user),h.current=e.user)}catch(e){}finally{m(!1)}};e();let{data:{subscription:t}}=b.auth.onAuthStateChange(async(e,t)=>{m(!0);try{"SIGNED_IN"===e&&t?(o(t),c(t.user),h.current=t.user):"SIGNED_OUT"===e?(o(null),c(null),h.current=null):"TOKEN_REFRESHED"===e&&t?(o(t),c(t.user)):"INITIAL_SESSION"===e&&(t?(o(t),c(t.user),h.current=t.user):(o(null),c(null),h.current=null))}catch(e){}finally{m(!1)}});return()=>{t.unsubscribe()}},[]);let g=(0,l.useCallback)(async(e,t)=>{let{error:s}=await b.auth.signInWithPassword({email:e,password:t});return{error:s}},[]),f=(0,l.useCallback)(async()=>{let{error:e}=await b.auth.signInWithOAuth({provider:"google",options:{redirectTo:"".concat(window.location.origin,"/auth/callback")}});return{error:e}},[]),p=(0,l.useCallback)(async e=>{let{error:t}=await b.auth.signInWithOtp({phone:e});return{error:t}},[]),j=(0,l.useCallback)(async(e,t)=>{let{error:s}=await b.auth.verifyOtp({phone:e,token:t,type:"sms"});return{error:s}},[]),y=(0,l.useCallback)(async(e,t)=>{let{error:s}=await b.auth.signUp({email:e,password:t});return{error:s}},[]),N=(0,l.useCallback)(async()=>{try{let{error:e}=await b.auth.signOut();if(e)throw e;o(null),c(null),h.current=null,localStorage.removeItem("supabase.auth.token"),localStorage.removeItem("supabase.auth.expires_at"),localStorage.removeItem("supabase.auth.refresh_token")}catch(e){throw e}},[]);return(0,a.jsx)(n.Provider,{value:{user:s,session:d,loading:x,signIn:g,signInWithGoogle:f,signInWithPhone:p,verifyPhoneOTP:j,signUp:y,signOut:N},children:t})}function d(){let e=(0,l.useContext)(n);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},1271:function(e,t,s){"use strict";s.d(t,{pm:function(){return m}});var a=s(2265);let l=0,r=new Map,i=e=>{if(r.has(e))return;let t=setTimeout(()=>{r.delete(e),o({type:"REMOVE_TOAST",toastId:e})},1e6);r.set(e,t)},n=(e,t)=>{switch(t.type){case"ADD_TOAST":return{...e,toasts:[t.toast,...e.toasts].slice(0,1)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(e=>e.id===t.toast.id?{...e,...t.toast}:e)};case"DISMISS_TOAST":{let{toastId:s}=t;return s?i(s):e.toasts.forEach(e=>{i(e.id)}),{...e,toasts:e.toasts.map(e=>e.id===s||void 0===s?{...e,open:!1}:e)}}case"REMOVE_TOAST":if(void 0===t.toastId)return{...e,toasts:[]};return{...e,toasts:e.toasts.filter(e=>e.id!==t.toastId)}}},c=[],d={toasts:[]};function o(e){d=n(d,e),c.forEach(e=>{e(d)})}function x(e){let{...t}=e,s=(l=(l+1)%Number.MAX_SAFE_INTEGER).toString(),a=()=>o({type:"DISMISS_TOAST",toastId:s});return o({type:"ADD_TOAST",toast:{...t,id:s,open:!0,onOpenChange:e=>{e||a()}}}),{id:s,dismiss:a,update:e=>o({type:"UPDATE_TOAST",toast:{...e,id:s}})}}function m(){let[e,t]=a.useState(d);return a.useEffect(()=>(c.push(t),()=>{let e=c.indexOf(t);e>-1&&c.splice(e,1)}),[e]),{...e,toast:x,dismiss:e=>o({type:"DISMISS_TOAST",toastId:e})}}},446:function(e,t,s){"use strict";s.d(t,{p:function(){return l}});var a=s(1271);let l=a.pm}},function(e){e.O(0,[216,744],function(){return e(e.s=261)}),_N_E=e.O()}]);