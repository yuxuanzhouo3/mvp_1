(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[576],{2441:function(e,a,s){Promise.resolve().then(s.bind(s,9647))},9647:function(e,a,s){"use strict";s.r(a),s.d(a,{default:function(){return _}});var t=s(7437),r=s(2265),i=s(4033),l=s(4620),c=s(2601),n=s(1492),d=s(9598),o=s(3611),h=s(5831),u=s(7702),m=s(708),x=s(446),g=s(3067),v=s(1827),f=s(2741),p=s(8339),j=s(290),y=s(2882),N=s(8734),b=s(1942),w=s(8438),k=s(6489),I=s(6020);function _(){var e,a;let s=(0,i.useParams)(),_=(0,i.useRouter)(),{user:C}=(0,l.a)(),{toast:z}=(0,x.p)(),S=s.chatId,[T,Z]=(0,r.useState)([]),[O,J]=(0,r.useState)(null),[E,R]=(0,r.useState)(""),[M,D]=(0,r.useState)(!1),[U,F]=(0,r.useState)(!0),[A,L]=(0,r.useState)(!1),P=(0,r.useRef)(null),X=(0,r.useRef)(null),V=(0,r.useRef)(null),Y=(0,n.eI)("https://bamratexknmqvdbalzen.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhbXJhdGV4a25tcXZkYmFsemVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MTM4NzEsImV4cCI6MjA2ODA4OTg3MX0.yYa98ioJLLouUgHWITGb7U_VjNCTUuM-5NcraM7f3zA"),{sendMessage:q,isConnected:Q}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{user:a}=(0,l.a)(),[s,t]=(0,r.useState)([]),[i,n]=(0,r.useState)(!1),[d,o]=(0,r.useState)(!1),[h,u]=(0,r.useState)(new Set),m=(0,r.useRef)(null),x=(0,r.useRef)(null),g=(0,r.useCallback)(()=>{if(!a||!e.chatId)return;let s=new WebSocket("".concat(c.env.NEXT_PUBLIC_WS_URL,"/chat/").concat(e.chatId));m.current=s,s.onopen=()=>{n(!0)},s.onmessage=a=>{try{var s,r,i,l;let c=JSON.parse(a.data);switch(c.type){case"message":let n=c.message;t(e=>[...e,n]),null===(s=e.onMessageReceived)||void 0===s||s.call(e,n);break;case"typing_start":u(e=>new Set(e).add(c.userId)),null===(r=e.onTyping)||void 0===r||r.call(e,c.userId,!0);break;case"typing_stop":u(e=>{let a=new Set(e);return a.delete(c.userId),a}),null===(i=e.onTyping)||void 0===i||i.call(e,c.userId,!1);break;case"ai_response":let d=c.message;t(e=>[...e,d]),null===(l=e.onMessageReceived)||void 0===l||l.call(e,d)}}catch(e){}},s.onclose=()=>{n(!1)},s.onerror=e=>{n(!1)}},[a,e.chatId,e.onMessageReceived,e.onTyping]),v=(0,r.useCallback)(()=>{m.current&&(m.current.close(),m.current=null)},[]),f=(0,r.useCallback)(async function(s){var t;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(!a||!e.chatId||!i)return;let l={content:s,sender_id:a.id,chat_id:e.chatId,is_ai:!1,attachments:r};null===(t=m.current)||void 0===t||t.send(JSON.stringify({type:"message",message:l}));try{await fetch("/api/chat/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)})}catch(e){}},[a,e.chatId,i]),p=(0,r.useCallback)(s=>{var t;a&&e.chatId&&i&&(null===(t=m.current)||void 0===t||t.send(JSON.stringify({type:"typing",userId:a.id,isTyping:s})),o(s))},[a,e.chatId,i]),j=(0,r.useCallback)(async()=>{if(e.chatId)try{let a=await fetch("/api/chat/messages?chatId=".concat(e.chatId));if(a.ok){let e=await a.json();t(e.messages||[])}}catch(e){}},[e.chatId]),y=(0,r.useCallback)(async s=>{var t;a&&e.chatId&&(null===(t=m.current)||void 0===t||t.send(JSON.stringify({type:"ai_message",content:s,userId:a.id,chatId:e.chatId})))},[a,e.chatId]);return(0,r.useEffect)(()=>(d&&(x.current&&clearTimeout(x.current),x.current=setTimeout(()=>{p(!1)},3e3)),()=>{x.current&&clearTimeout(x.current)}),[d,p]),(0,r.useEffect)(()=>(e.chatId&&(g(),j()),()=>{v()}),[e.chatId,g,v,j]),{messages:s,isConnected:i,isTyping:d,typingUsers:h,sendMessage:f,sendTyping:p,sendAIMessage:y,loadMessages:j}}({chatId:S});(0,r.useEffect)(()=>{if(!C){_.push("/auth/login");return}B()},[S,C]),(0,r.useEffect)(()=>{G()},[T]);let B=async()=>{try{F(!0);let{data:{session:e}}=await Y.auth.getSession(),a=null==e?void 0:e.access_token;if(!a)return;let s={Authorization:"Bearer ".concat(a),"Content-Type":"application/json"},t=await fetch("/api/chat/".concat(S,"/messages"),{headers:s});if(t.ok){let e=await t.json();Z(e.messages)}let r=await fetch("/api/chat/".concat(S,"/user"),{headers:s});if(r.ok){let e=await r.json();J(e.user)}}catch(e){z({title:"加载失败",description:"无法加载聊天数据",variant:"destructive"})}finally{F(!1)}},G=()=>{var e;null===(e=P.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},W=async()=>{if(E.trim()&&Q)try{await q(E),R("")}catch(e){z({title:"发送失败",description:"消息发送失败，请重试",variant:"destructive"})}},$=async e=>{var a;let s=null===(a=e.target.files)||void 0===a?void 0:a[0];if(s)try{let e=new FormData;e.append("file",s),e.append("chatId",S);let a=await fetch("/api/chat/upload",{method:"POST",body:e});if(a.ok){let e=await a.json();await q("",[e.file_url]),z({title:"文件上传成功",description:"文件已发送"})}}catch(e){z({title:"上传失败",description:"文件上传失败，请重试",variant:"destructive"})}},K=async e=>{var a;let s=null===(a=e.target.files)||void 0===a?void 0:a[0];if(s)try{let e=new FormData;e.append("image",s),e.append("chatId",S);let a=await fetch("/api/chat/upload-image",{method:"POST",body:e});if(a.ok){let e=await a.json();await q("",[e.image_url]),z({title:"图片上传成功",description:"图片已发送"})}}catch(e){z({title:"上传失败",description:"图片上传失败，请重试",variant:"destructive"})}},H=e=>{let a=new Date(e),s=new Date,t=(s.getTime()-a.getTime())/36e5;return t<24?a.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):a.toLocaleDateString("zh-CN")};return U?(0,t.jsx)("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),(0,t.jsx)("p",{className:"text-gray-600 dark:text-gray-400",children:"加载聊天中..."})]})}):O?(0,t.jsxs)("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex flex-col",children:[(0,t.jsx)("div",{className:"bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,t.jsx)(o.z,{variant:"ghost",size:"sm",onClick:()=>_.push("/chat"),className:"lg:hidden",children:(0,t.jsx)(g.Z,{className:"h-4 w-4"})}),(0,t.jsxs)(u.qE,{children:[(0,t.jsx)(u.F$,{src:O.avatar_url}),(0,t.jsx)(u.Q5,{children:null===(e=O.full_name)||void 0===e?void 0:e.charAt(0).toUpperCase()})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h2",{className:"font-semibold text-gray-900 dark:text-white",children:O.full_name}),(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)("div",{className:"w-2 h-2 rounded-full ".concat(O.is_online?"bg-green-500":"bg-gray-400")}),(0,t.jsx)("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:O.is_online?"在线":"离线"})]})]})]}),(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(o.z,{variant:"ghost",size:"sm",children:(0,t.jsx)(v.Z,{className:"h-4 w-4"})}),(0,t.jsx)(o.z,{variant:"ghost",size:"sm",children:(0,t.jsx)(f.Z,{className:"h-4 w-4"})}),(0,t.jsx)(o.z,{variant:"ghost",size:"sm",children:(0,t.jsx)(p.Z,{className:"h-4 w-4"})}),(0,t.jsx)(o.z,{variant:"ghost",size:"sm",children:(0,t.jsx)(j.Z,{className:"h-4 w-4"})})]})]})}),(0,t.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[0===T.length?(0,t.jsxs)("div",{className:"text-center py-8",children:[(0,t.jsx)(y.Z,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),(0,t.jsxs)("p",{className:"text-gray-600 dark:text-gray-400 mb-2",children:["开始与 ",O.full_name," 的对话"]}),(0,t.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-500",children:"发送第一条消息来开始聊天"})]}):T.map(e=>{var a;let s=e.sender_id===(null==C?void 0:C.id);return(0,t.jsx)("div",{className:"flex ".concat(s?"justify-end":"justify-start"),children:(0,t.jsxs)("div",{className:"flex items-end space-x-2 max-w-xs lg:max-w-md ".concat(s?"flex-row-reverse space-x-reverse":""),children:[!s&&(0,t.jsxs)(u.qE,{className:"h-8 w-8",children:[(0,t.jsx)(u.F$,{src:O.avatar_url}),(0,t.jsx)(u.Q5,{children:null===(a=O.full_name)||void 0===a?void 0:a.charAt(0).toUpperCase()})]}),(0,t.jsxs)("div",{className:"rounded-lg px-4 py-2 ".concat(s?"bg-blue-600 text-white":"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700"),children:["text"===e.message_type&&(0,t.jsx)("p",{className:"text-sm",children:e.content}),"image"===e.message_type&&(0,t.jsx)("img",{src:e.file_url,alt:"Shared image",className:"rounded max-w-full h-auto"}),"file"===e.message_type&&(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(N.Z,{className:"h-4 w-4"}),(0,t.jsx)("span",{className:"text-sm",children:"文件已发送"})]}),(0,t.jsxs)("div",{className:"text-xs mt-1 ".concat(s?"text-blue-100":"text-gray-500 dark:text-gray-400"),children:[H(e.created_at),s&&(0,t.jsx)("span",{className:"ml-2",children:e.is_read?"✓✓":"✓"})]})]})]})},e.id)}),M&&(0,t.jsx)("div",{className:"flex justify-start",children:(0,t.jsxs)("div",{className:"flex items-end space-x-2",children:[(0,t.jsxs)(u.qE,{className:"h-8 w-8",children:[(0,t.jsx)(u.F$,{src:O.avatar_url}),(0,t.jsx)(u.Q5,{children:null===(a=O.full_name)||void 0===a?void 0:a.charAt(0).toUpperCase()})]}),(0,t.jsx)("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-4 py-2",children:(0,t.jsxs)("div",{className:"flex space-x-1",children:[(0,t.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce"}),(0,t.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),(0,t.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]})})]})}),(0,t.jsx)("div",{ref:P})]}),(0,t.jsxs)("div",{className:"bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(o.z,{variant:"ghost",size:"sm",onClick:()=>L(!A),children:(0,t.jsx)(b.Z,{className:"h-4 w-4"})}),A&&(0,t.jsxs)("div",{className:"flex space-x-2",children:[(0,t.jsx)(o.z,{variant:"ghost",size:"sm",onClick:()=>{var e;return null===(e=V.current)||void 0===e?void 0:e.click()},children:(0,t.jsx)(w.Z,{className:"h-4 w-4"})}),(0,t.jsx)(o.z,{variant:"ghost",size:"sm",onClick:()=>{var e;return null===(e=X.current)||void 0===e?void 0:e.click()},children:(0,t.jsx)(N.Z,{className:"h-4 w-4"})})]}),(0,t.jsx)("div",{className:"flex-1",children:(0,t.jsx)(h.I,{value:E,onChange:e=>R(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),W())},placeholder:"输入消息...",className:"border-0 focus:ring-0"})}),(0,t.jsx)(o.z,{variant:"ghost",size:"sm",onClick:()=>{},children:(0,t.jsx)(k.Z,{className:"h-4 w-4"})}),(0,t.jsx)(o.z,{onClick:W,disabled:!E.trim()||!Q,size:"sm",children:(0,t.jsx)(I.Z,{className:"h-4 w-4"})})]}),!Q&&(0,t.jsx)("div",{className:"mt-2 text-center",children:(0,t.jsx)(m.C,{variant:"destructive",className:"text-xs",children:"连接断开，正在重连..."})})]}),(0,t.jsx)("input",{ref:X,type:"file",className:"hidden",onChange:$,accept:".pdf,.doc,.docx,.txt"}),(0,t.jsx)("input",{ref:V,type:"file",className:"hidden",onChange:K,accept:"image/*"})]}):(0,t.jsx)("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:(0,t.jsxs)(d.Zb,{className:"w-full max-w-md",children:[(0,t.jsx)(d.Ol,{children:(0,t.jsx)(d.ll,{children:"聊天未找到"})}),(0,t.jsx)(d.aY,{children:(0,t.jsx)(o.z,{onClick:()=>_.push("/chat"),className:"w-full",children:"返回聊天列表"})})]})})}}},function(e){e.O(0,[216,76,744],function(){return e(e.s=2441)}),_N_E=e.O()}]);