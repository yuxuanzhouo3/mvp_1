(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[576],{2441:function(e,a,t){Promise.resolve().then(t.bind(t,9647))},9647:function(e,a,t){"use strict";t.r(a),t.d(a,{default:function(){return C}});var s=t(7437),r=t(2265),l=t(4033),n=t(4620),i=t(2601),c=t(9598),d=t(3611),o=t(5831),u=t(7702),f=t(708),m=t(446),x=t(3067),h=t(1827),g=t(2741),p=t(8339),v=t(290),y=t(2882),j=t(8734),N=t(1942),b=t(8438),w=t(6489),k=t(6020);function C(){var e,a;let t=(0,l.useParams)(),C=(0,l.useRouter)(),{user:_}=(0,n.a)(),{toast:I}=(0,m.p)(),S=t.chatId,[z,R]=(0,r.useState)([]),[E,T]=(0,r.useState)(null),[Z,O]=(0,r.useState)(""),[D,F]=(0,r.useState)(!1),[P,q]=(0,r.useState)(!0),[J,U]=(0,r.useState)(!1),L=(0,r.useRef)(null),Q=(0,r.useRef)(null),Y=(0,r.useRef)(null),{sendMessage:$,isConnected:A}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{user:a}=(0,n.a)(),[t,s]=(0,r.useState)([]),[l,c]=(0,r.useState)(!1),[d,o]=(0,r.useState)(!1),[u,f]=(0,r.useState)(new Set),m=(0,r.useRef)(null),x=(0,r.useRef)(null),h=(0,r.useCallback)(()=>{if(!a||!e.chatId)return;let t=new WebSocket("".concat(i.env.NEXT_PUBLIC_WS_URL,"/chat/").concat(e.chatId));m.current=t,t.onopen=()=>{c(!0)},t.onmessage=a=>{try{var t,r,l,n;let i=JSON.parse(a.data);switch(i.type){case"message":let c=i.message;s(e=>[...e,c]),null===(t=e.onMessageReceived)||void 0===t||t.call(e,c);break;case"typing_start":f(e=>new Set(e).add(i.userId)),null===(r=e.onTyping)||void 0===r||r.call(e,i.userId,!0);break;case"typing_stop":f(e=>{let a=new Set(e);return a.delete(i.userId),a}),null===(l=e.onTyping)||void 0===l||l.call(e,i.userId,!1);break;case"ai_response":let d=i.message;s(e=>[...e,d]),null===(n=e.onMessageReceived)||void 0===n||n.call(e,d)}}catch(e){}},t.onclose=()=>{c(!1)},t.onerror=e=>{c(!1)}},[a,e.chatId,e.onMessageReceived,e.onTyping]),g=(0,r.useCallback)(()=>{m.current&&(m.current.close(),m.current=null)},[]),p=(0,r.useCallback)(async function(t){var s;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(!a||!e.chatId||!l)return;let n={content:t,sender_id:a.id,chat_id:e.chatId,is_ai:!1,attachments:r};null===(s=m.current)||void 0===s||s.send(JSON.stringify({type:"message",message:n}));try{await fetch("/api/chat/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})}catch(e){}},[a,e.chatId,l]),v=(0,r.useCallback)(t=>{var s;a&&e.chatId&&l&&(null===(s=m.current)||void 0===s||s.send(JSON.stringify({type:"typing",userId:a.id,isTyping:t})),o(t))},[a,e.chatId,l]),y=(0,r.useCallback)(async()=>{if(e.chatId)try{let a=await fetch("/api/chat/messages?chatId=".concat(e.chatId));if(a.ok){let e=await a.json();s(e.messages||[])}}catch(e){}},[e.chatId]),j=(0,r.useCallback)(async t=>{var s;a&&e.chatId&&(null===(s=m.current)||void 0===s||s.send(JSON.stringify({type:"ai_message",content:t,userId:a.id,chatId:e.chatId})))},[a,e.chatId]);return(0,r.useEffect)(()=>(d&&(x.current&&clearTimeout(x.current),x.current=setTimeout(()=>{v(!1)},3e3)),()=>{x.current&&clearTimeout(x.current)}),[d,v]),(0,r.useEffect)(()=>(e.chatId&&(h(),y()),()=>{g()}),[e.chatId,h,g,y]),{messages:t,isConnected:l,isTyping:d,typingUsers:u,sendMessage:p,sendTyping:v,sendAIMessage:j,loadMessages:y}}({chatId:S});(0,r.useEffect)(()=>{if(!_){C.push("/auth/login");return}M()},[S,_]),(0,r.useEffect)(()=>{K()},[z]);let M=async()=>{try{q(!0);let e=await fetch("/api/chat/".concat(S,"/messages"));if(e.ok){let a=await e.json();R(a.messages)}let a=await fetch("/api/chat/".concat(S,"/user"));if(a.ok){let e=await a.json();T(e.user)}}catch(e){I({title:"加载失败",description:"无法加载聊天数据",variant:"destructive"})}finally{q(!1)}},K=()=>{var e;null===(e=L.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},V=async()=>{if(Z.trim()&&A)try{await $(Z),O("")}catch(e){I({title:"发送失败",description:"消息发送失败，请重试",variant:"destructive"})}},W=async e=>{var a;let t=null===(a=e.target.files)||void 0===a?void 0:a[0];if(t)try{let e=new FormData;e.append("file",t),e.append("chatId",S);let a=await fetch("/api/chat/upload",{method:"POST",body:e});if(a.ok){let e=await a.json();await $("",[e.file_url]),I({title:"文件上传成功",description:"文件已发送"})}}catch(e){I({title:"上传失败",description:"文件上传失败，请重试",variant:"destructive"})}},B=async e=>{var a;let t=null===(a=e.target.files)||void 0===a?void 0:a[0];if(t)try{let e=new FormData;e.append("image",t),e.append("chatId",S);let a=await fetch("/api/chat/upload-image",{method:"POST",body:e});if(a.ok){let e=await a.json();await $("",[e.image_url]),I({title:"图片上传成功",description:"图片已发送"})}}catch(e){I({title:"上传失败",description:"图片上传失败，请重试",variant:"destructive"})}},H=e=>{let a=new Date(e),t=new Date,s=(t.getTime()-a.getTime())/36e5;return s<24?a.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):a.toLocaleDateString("zh-CN")};return P?(0,s.jsx)("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),(0,s.jsx)("p",{className:"text-gray-600 dark:text-gray-400",children:"加载聊天中..."})]})}):E?(0,s.jsxs)("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex flex-col",children:[(0,s.jsx)("div",{className:"bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4",children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,s.jsx)(d.z,{variant:"ghost",size:"sm",onClick:()=>C.push("/chat"),className:"lg:hidden",children:(0,s.jsx)(x.Z,{className:"h-4 w-4"})}),(0,s.jsxs)(u.qE,{children:[(0,s.jsx)(u.F$,{src:E.avatar_url}),(0,s.jsx)(u.Q5,{children:null===(e=E.full_name)||void 0===e?void 0:e.charAt(0).toUpperCase()})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"font-semibold text-gray-900 dark:text-white",children:E.full_name}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)("div",{className:"w-2 h-2 rounded-full ".concat(E.is_online?"bg-green-500":"bg-gray-400")}),(0,s.jsx)("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:E.is_online?"在线":"离线"})]})]})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)(d.z,{variant:"ghost",size:"sm",children:(0,s.jsx)(h.Z,{className:"h-4 w-4"})}),(0,s.jsx)(d.z,{variant:"ghost",size:"sm",children:(0,s.jsx)(g.Z,{className:"h-4 w-4"})}),(0,s.jsx)(d.z,{variant:"ghost",size:"sm",children:(0,s.jsx)(p.Z,{className:"h-4 w-4"})}),(0,s.jsx)(d.z,{variant:"ghost",size:"sm",children:(0,s.jsx)(v.Z,{className:"h-4 w-4"})})]})]})}),(0,s.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[0===z.length?(0,s.jsxs)("div",{className:"text-center py-8",children:[(0,s.jsx)(y.Z,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),(0,s.jsxs)("p",{className:"text-gray-600 dark:text-gray-400 mb-2",children:["开始与 ",E.full_name," 的对话"]}),(0,s.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-500",children:"发送第一条消息来开始聊天"})]}):z.map(e=>{var a;let t=e.sender_id===(null==_?void 0:_.id);return(0,s.jsx)("div",{className:"flex ".concat(t?"justify-end":"justify-start"),children:(0,s.jsxs)("div",{className:"flex items-end space-x-2 max-w-xs lg:max-w-md ".concat(t?"flex-row-reverse space-x-reverse":""),children:[!t&&(0,s.jsxs)(u.qE,{className:"h-8 w-8",children:[(0,s.jsx)(u.F$,{src:E.avatar_url}),(0,s.jsx)(u.Q5,{children:null===(a=E.full_name)||void 0===a?void 0:a.charAt(0).toUpperCase()})]}),(0,s.jsxs)("div",{className:"rounded-lg px-4 py-2 ".concat(t?"bg-blue-600 text-white":"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700"),children:["text"===e.message_type&&(0,s.jsx)("p",{className:"text-sm",children:e.content}),"image"===e.message_type&&(0,s.jsx)("img",{src:e.file_url,alt:"Shared image",className:"rounded max-w-full h-auto"}),"file"===e.message_type&&(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)(j.Z,{className:"h-4 w-4"}),(0,s.jsx)("span",{className:"text-sm",children:"文件已发送"})]}),(0,s.jsxs)("div",{className:"text-xs mt-1 ".concat(t?"text-blue-100":"text-gray-500 dark:text-gray-400"),children:[H(e.created_at),t&&(0,s.jsx)("span",{className:"ml-2",children:e.is_read?"✓✓":"✓"})]})]})]})},e.id)}),D&&(0,s.jsx)("div",{className:"flex justify-start",children:(0,s.jsxs)("div",{className:"flex items-end space-x-2",children:[(0,s.jsxs)(u.qE,{className:"h-8 w-8",children:[(0,s.jsx)(u.F$,{src:E.avatar_url}),(0,s.jsx)(u.Q5,{children:null===(a=E.full_name)||void 0===a?void 0:a.charAt(0).toUpperCase()})]}),(0,s.jsx)("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-4 py-2",children:(0,s.jsxs)("div",{className:"flex space-x-1",children:[(0,s.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce"}),(0,s.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),(0,s.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]})})]})}),(0,s.jsx)("div",{ref:L})]}),(0,s.jsxs)("div",{className:"bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)(d.z,{variant:"ghost",size:"sm",onClick:()=>U(!J),children:(0,s.jsx)(N.Z,{className:"h-4 w-4"})}),J&&(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)(d.z,{variant:"ghost",size:"sm",onClick:()=>{var e;return null===(e=Y.current)||void 0===e?void 0:e.click()},children:(0,s.jsx)(b.Z,{className:"h-4 w-4"})}),(0,s.jsx)(d.z,{variant:"ghost",size:"sm",onClick:()=>{var e;return null===(e=Q.current)||void 0===e?void 0:e.click()},children:(0,s.jsx)(j.Z,{className:"h-4 w-4"})})]}),(0,s.jsx)("div",{className:"flex-1",children:(0,s.jsx)(o.I,{value:Z,onChange:e=>O(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),V())},placeholder:"输入消息...",className:"border-0 focus:ring-0"})}),(0,s.jsx)(d.z,{variant:"ghost",size:"sm",onClick:()=>{},children:(0,s.jsx)(w.Z,{className:"h-4 w-4"})}),(0,s.jsx)(d.z,{onClick:V,disabled:!Z.trim()||!A,size:"sm",children:(0,s.jsx)(k.Z,{className:"h-4 w-4"})})]}),!A&&(0,s.jsx)("div",{className:"mt-2 text-center",children:(0,s.jsx)(f.C,{variant:"destructive",className:"text-xs",children:"连接断开，正在重连..."})})]}),(0,s.jsx)("input",{ref:Q,type:"file",className:"hidden",onChange:W,accept:".pdf,.doc,.docx,.txt"}),(0,s.jsx)("input",{ref:Y,type:"file",className:"hidden",onChange:B,accept:"image/*"})]}):(0,s.jsx)("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:(0,s.jsxs)(c.Zb,{className:"w-full max-w-md",children:[(0,s.jsx)(c.Ol,{children:(0,s.jsx)(c.ll,{children:"聊天未找到"})}),(0,s.jsx)(c.aY,{children:(0,s.jsx)(d.z,{onClick:()=>C.push("/chat"),className:"w-full",children:"返回聊天列表"})})]})})}},7702:function(e,a,t){"use strict";t.d(a,{F$:function(){return c},Q5:function(){return d},qE:function(){return i}});var s=t(7437),r=t(2265),l=t(1465),n=t(1628);let i=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)(l.fC,{ref:a,className:(0,n.cn)("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",t),...r})});i.displayName=l.fC.displayName;let c=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)(l.Ee,{ref:a,className:(0,n.cn)("aspect-square h-full w-full",t),...r})});c.displayName=l.Ee.displayName;let d=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)(l.NY,{ref:a,className:(0,n.cn)("flex h-full w-full items-center justify-center rounded-full bg-muted",t),...r})});d.displayName=l.NY.displayName},708:function(e,a,t){"use strict";t.d(a,{C:function(){return i}});var s=t(7437);t(2265);var r=t(6061),l=t(1628);let n=(0,r.j)("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function i(e){let{className:a,variant:t,...r}=e;return(0,s.jsx)("div",{className:(0,l.cn)(n({variant:t}),a),...r})}},9598:function(e,a,t){"use strict";t.d(a,{Ol:function(){return i},SZ:function(){return d},Zb:function(){return n},aY:function(){return o},ll:function(){return c}});var s=t(7437),r=t(2265),l=t(1628);let n=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)("div",{ref:a,className:(0,l.cn)("rounded-lg border bg-card text-card-foreground shadow-sm",t),...r})});n.displayName="Card";let i=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)("div",{ref:a,className:(0,l.cn)("flex flex-col space-y-1.5 p-6",t),...r})});i.displayName="CardHeader";let c=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)("h3",{ref:a,className:(0,l.cn)("text-2xl font-semibold leading-none tracking-tight",t),...r})});c.displayName="CardTitle";let d=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)("p",{ref:a,className:(0,l.cn)("text-sm text-muted-foreground",t),...r})});d.displayName="CardDescription";let o=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)("div",{ref:a,className:(0,l.cn)("p-6 pt-0",t),...r})});o.displayName="CardContent";let u=r.forwardRef((e,a)=>{let{className:t,...r}=e;return(0,s.jsx)("div",{ref:a,className:(0,l.cn)("flex items-center p-6 pt-0",t),...r})});u.displayName="CardFooter"},5831:function(e,a,t){"use strict";t.d(a,{I:function(){return n}});var s=t(7437),r=t(2265),l=t(1628);let n=r.forwardRef((e,a)=>{let{className:t,type:r,label:n,error:i,icon:c,description:d,...o}=e;return(0,s.jsxs)("div",{className:"w-full space-y-1",children:[n&&(0,s.jsx)("label",{className:"block text-sm font-medium text-foreground",children:n}),(0,s.jsxs)("div",{className:"relative",children:[c&&(0,s.jsx)("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:c}),(0,s.jsx)("input",{type:r,className:(0,l.cn)("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background","file:border-0 file:bg-transparent file:text-sm file:font-medium","placeholder:text-muted-foreground","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2","disabled:cursor-not-allowed disabled:opacity-50",c?"pl-10":"",i?"border-destructive focus-visible:ring-destructive/30":"",t),ref:a,...o})]}),d&&!i&&(0,s.jsx)("p",{className:"text-xs text-muted-foreground",children:d}),i&&(0,s.jsx)("p",{className:"text-xs text-destructive",children:i})]})});n.displayName="Input"},446:function(e,a,t){"use strict";t.d(a,{p:function(){return r}});var s=t(1271);let r=s.pm}},function(e){e.O(0,[216,689,744],function(){return e(e.s=2441)}),_N_E=e.O()}]);